<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Phone Verification Test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { 
      font-family: Arial, Helvetica, sans-serif; 
      padding: 40px; 
      max-width: 600px; 
      margin: 0 auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .card { 
      background: white;
      padding: 30px; 
      border-radius: 12px; 
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }
    h1 { 
      margin-top: 0; 
      color: #333;
      font-size: 28px;
    }
    label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 600;
      color: #555;
    }
    input { 
      width: 100%; 
      padding: 12px; 
      font-size: 16px; 
      border: 2px solid #ddd;
      border-radius: 6px;
      box-sizing: border-box;
      margin-bottom: 16px;
    }
    input:focus {
      outline: none;
      border-color: #9c27b0;
    }
    button { 
      padding: 14px 24px; 
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 10px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .btn-send { 
      background: #9c27b0; 
      color: white;
    }
    .btn-verify { 
      background: #673ab7; 
      color: white;
    }
    .log { 
      margin-top: 20px; 
      background: #f5f5f5; 
      padding: 15px; 
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      border-left: 4px solid #9c27b0;
    }
    .log-entry {
      margin-bottom: 8px;
      padding: 4px 0;
    }
    .log-success { color: #2e7d32; }
    .log-error { color: #c62828; }
    .log-info { color: #1565c0; }
    #otpInputSection {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      border: 2px dashed #9c27b0;
    }
    .status {
      padding: 12px;
      border-radius: 6px;
      margin-top: 15px;
      font-weight: 600;
    }
    .status-success {
      background: #c8e6c9;
      color: #2e7d32;
      border: 2px solid #4caf50;
    }
    .status-error {
      background: #ffcdd2;
      color: #c62828;
      border: 2px solid #f44336;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ðŸ“± Phone Verification (OTP)</h1>
    <p style="color: #666; margin-bottom: 30px;">Test Twilio Verify service for OTP verification</p>

    <label for="verifyPhone">Phone Number (E.164 format)</label>
    <input 
      id="verifyPhone" 
      type="tel"
      placeholder="+61412345678" 
      value="+61"
    />

    <div>
      <button id="sendOtp" class="btn-send">ðŸ“¤ Send OTP</button>
    </div>

    <div id="otpInputSection" style="display:none;">
      <label for="otpCode">Enter Verification Code</label>
      <input 
        id="otpCode" 
        type="text"
        placeholder="Enter 6-digit code" 
        maxlength="6" 
        pattern="[0-9]*"
        inputmode="numeric"
      />
      <button id="checkOtp" class="btn-verify">âœ… Verify Code</button>
    </div>

    <div id="statusMessage"></div>

    <div class="log" id="verifyLog">
      <div class="log-info">Ready to send verification code...</div>
    </div>
  </div>

  <script>
    const verifyLogEl = document.getElementById('verifyLog');
    
    function verifyLog(msg, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${timestamp}] ${msg}`;
      verifyLogEl.insertBefore(entry, verifyLogEl.firstChild);
    }

    function showStatus(msg, isError = false) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.className = `status ${isError ? 'status-error' : 'status-success'}`;
      statusEl.textContent = msg;
      statusEl.style.display = 'block';
    }

    let currentVerificationPhone = null;

    document.getElementById('sendOtp').addEventListener('click', async () => {
      const phone = document.getElementById('verifyPhone').value.trim();
      if (!phone) {
        verifyLog('âŒ Please enter a phone number', 'error');
        alert('Please enter a phone number in E.164 format (e.g. +61412345678)');
        return;
      }
      if (!phone.startsWith('+')) {
        verifyLog('âŒ Phone must be in E.164 format (start with +)', 'error');
        alert('Phone must be in E.164 format (start with +)');
        return;
      }

      try {
        verifyLog(`ðŸ“¤ Sending verification code to ${phone}...`, 'info');
        const res = await fetch('http://localhost:4004/verify/send', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ to: phone, channel: 'sms' })
        });
        const j = await res.json();
        verifyLog(`Response: ${JSON.stringify(j)}`, 'info');

        if (j && j.ok && j.status === 'pending') {
          currentVerificationPhone = phone;
          document.getElementById('otpInputSection').style.display = 'block';
          document.getElementById('otpCode').value = '';
          document.getElementById('otpCode').focus();
          showStatus(`âœ… Verification code sent to ${phone}! Check your SMS.`, false);
          verifyLog(`âœ… Code sent successfully! Status: ${j.status}`, 'success');
        } else {
          verifyLog(`âŒ Failed: ${JSON.stringify(j)}`, 'error');
          showStatus('Failed to send verification code', true);
        }
      } catch (err) {
        verifyLog(`âŒ Error: ${err.message}`, 'error');
        showStatus('Error sending verification code: ' + err.message, true);
      }
    });

    document.getElementById('checkOtp').addEventListener('click', async () => {
      const code = document.getElementById('otpCode').value.trim();
      if (!code) {
        verifyLog('âŒ Please enter the verification code', 'error');
        alert('Please enter the verification code from your SMS');
        return;
      }
      if (!currentVerificationPhone) {
        verifyLog('âŒ No active verification session', 'error');
        alert('Please send a verification code first');
        return;
      }

      try {
        verifyLog(`ðŸ” Verifying code ${code} for ${currentVerificationPhone}...`, 'info');
        const res = await fetch('http://localhost:4004/verify/check', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ to: currentVerificationPhone, code })
        });
        const j = await res.json();
        verifyLog(`Response: ${JSON.stringify(j)}`, 'info');

        if (j && j.ok && j.verified) {
          verifyLog(`âœ…âœ…âœ… VERIFIED! Phone ${currentVerificationPhone} confirmed`, 'success');
          showStatus(`ðŸŽ‰ SUCCESS! Phone number ${currentVerificationPhone} has been verified!`, false);
          // Reset state
          setTimeout(() => {
            document.getElementById('otpInputSection').style.display = 'none';
            currentVerificationPhone = null;
          }, 3000);
        } else if (j && !j.verified) {
          verifyLog(`âŒ Verification failed - incorrect code or expired`, 'error');
          showStatus('âŒ Verification failed! The code is incorrect or has expired.', true);
        } else {
          verifyLog(`âŒ Failed: ${JSON.stringify(j)}`, 'error');
          showStatus('Verification failed', true);
        }
      } catch (err) {
        verifyLog(`âŒ Error: ${err.message}`, 'error');
        showStatus('Error verifying code: ' + err.message, true);
      }
    });

    // Allow Enter key to submit OTP code
    document.getElementById('otpCode').addEventListener('keypress', (ev) => {
      if (ev.key === 'Enter') {
        ev.preventDefault();
        document.getElementById('checkOtp').click();
      }
    });

    // Also allow Enter on phone input
    document.getElementById('verifyPhone').addEventListener('keypress', (ev) => {
      if (ev.key === 'Enter') {
        ev.preventDefault();
        document.getElementById('sendOtp').click();
      }
    });
  </script>
</body>
</html>
