# CSC3104 Cloud Project - Group 25
# Backend Microservices Stack (HiveMQ MQTT + gRPC)
# Run with: docker-compose up --build

services:
  # --------------------------------------
  # HIVEMQ MQTT BROKER
  # --------------------------------------
  hivemq:
    image: hivemq/hivemq-ce:latest
    container_name: hivemq
    ports:
      - "1883:1883"      # MQTT
      - "8080:8080"      # HiveMQ Control Center Web UI
    environment:
      TZ: "Asia/Singapore"
    volumes:
      - hivemq-data:/opt/hivemq/data
      - hivemq-log:/opt/hivemq/log
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/1883' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  # --------------------------------------
  # MONGODB DATABASE
  # --------------------------------------
  mongo:
    image: mongo:7
    container_name: mongo
    environment:
      TZ: "Asia/Singapore"
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --------------------------------------
  # EVENT DISPATCHER SERVICE (formerly notification-service)
  # Handles event routing, user management, check-ins, gRPC server
  # --------------------------------------
  notification:
    build:
      context: .
      dockerfile: ./services/notification-service/Dockerfile
    container_name: notification
    depends_on:
      hivemq:
        condition: service_healthy
      mongo:
        condition: service_healthy
    env_file:
      - config/secrets/.env
    environment:
      - TZ=Asia/Singapore
      - MQTT_BROKER=hivemq
      - MQTT_PORT=1883
      - EMAIL_USER=${EMAIL_USER}
      - EMAIL_PASS=${EMAIL_PASS}
    volumes:
      - ./config/secrets:/app/config/secrets:ro
      - ./shared/testing-ui:/app/testing-notification:ro
    ports:
      - "4002:4002"
      - "50051:50051"
    restart: unless-stopped

  # --------------------------------------
  # PUSH NOTIFICATION SERVICE
  # Firebase Cloud Messaging push notifications for mobile devices
  # --------------------------------------
  push-notification:
    build:
      context: .
      dockerfile: ./services/push-notification-service/Dockerfile
    container_name: push-notification
    depends_on:
      hivemq:
        condition: service_healthy
      mongo:
        condition: service_healthy
    env_file:
      - config/secrets/.env
    environment:
      - TZ=Asia/Singapore
      - MQTT_BROKER=hivemq
      - MQTT_PORT=1883
      - MONGO_URI=mongodb://mongo:27017/notification
      - FIREBASE_SERVICE_ACCOUNT_JSON=${FIREBASE_SERVICE_ACCOUNT_JSON:-}
      - FIREBASE_SERVICE_ACCOUNT_PATH=${FIREBASE_SERVICE_ACCOUNT_PATH:-/app/config/secrets/firebase-sa.json}
    volumes:
      - ./config/secrets:/app/config/secrets:ro
    ports:
      - "4020:4020"
    restart: unless-stopped

  # --------------------------------------
  # SMS SERVICE
  # Sends SMS messages via Twilio, subscribes to MQTT for event-driven messaging
  # --------------------------------------
  sms:
    build:
      context: .
      dockerfile: ./services/sms-service/Dockerfile
    container_name: sms
    depends_on:
      hivemq:
        condition: service_healthy
    env_file:
      - config/secrets/.env
    environment:
      - TZ=Asia/Singapore
      - MQTT_BROKER=hivemq
      - MQTT_PORT=1883
    ports:
      - "4004:4004"
    restart: unless-stopped

  # --------------------------------------
  # EMAIL SERVICE
  # Sends emails via Gmail SMTP, subscribes to MQTT for event-driven messaging
  # --------------------------------------
  email:
    build:
      context: .
      dockerfile: ./services/email-service/Dockerfile
    container_name: email
    depends_on:
      hivemq:
        condition: service_healthy
    env_file:
      - config/secrets/.env
    environment:
      - TZ=Asia/Singapore
      - MQTT_BROKER=hivemq
      - MQTT_PORT=1883
    ports:
      - "4003:4003"
    restart: unless-stopped

  # --------------------------------------
  # AI COMPANION SERVICE (Google Gemini 2.0 Flash - 100% FREE)
  # --------------------------------------
  ai-companion:
    build:
      context: .
      dockerfile: ./services/ai-companion-service/Dockerfile
    container_name: ai-companion
    depends_on:
      hivemq:
        condition: service_healthy
      mongo:
        condition: service_healthy
    env_file:
      - config/secrets/.env
    environment:
      - TZ=Asia/Singapore
      - MQTT_BROKER=hivemq
      - MQTT_PORT=1883
      - MONGO_URI=mongodb://mongo:27017/ai-companion
    ports:
      - "4015:4015"
    restart: unless-stopped


# --------------------------------------
# DATA VOLUMES
# --------------------------------------
volumes:
  mongo-data:
  hivemq-data:
  hivemq-log:
