services:
  notification:
    # Use an env file for sensitive client config (do NOT commit .env)
    env_file:
      - config/secrets/.env
    volumes:
      # Mount local Firebase service account JSON into the container if present
      - ./config/secrets/firebase-sa.json:/app/config/secrets/firebase-sa.json:ro
      - ./shared/testing-ui:/app/testing-notification:ro
    environment:
      # Path the app expects for the service account JSON inside the container
      FIREBASE_SERVICE_ACCOUNT_PATH: /app/config/secrets/firebase-sa.json
      # Keep the fallback toggle in the override to ease local debugging
      FCM_FALLBACK_V1: 'true'
    ports:
      - "50051:50051"

  email:
    build:
      context: .
      dockerfile: ./services/email-service/Dockerfile
    container_name: email
    depends_on:
      kafka:
        condition: service_healthy
      mongo:
        condition: service_healthy
    env_file:
      - config/secrets/.env
    environment:
      - KAFKA_BROKER=kafka:9092
    restart: unless-stopped
    ports:
      - "4003:4003" # metrics endpoint for email-service

  sms:
    build:
      context: .
      dockerfile: ./services/sms-service/Dockerfile
    container_name: sms
    env_file:
      - config/secrets/.env
    environment:
      - KAFKA_BROKER=kafka:9092
      - METRICS_PORT=4004
    depends_on:
      kafka:
        condition: service_healthy
    restart: unless-stopped
    ports:
      - "4004:4004"

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards:ro
    restart: unless-stopped

volumes:
  grafana_data:
