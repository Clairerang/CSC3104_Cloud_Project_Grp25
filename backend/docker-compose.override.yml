services:
  event-dispatcher:
    # Use an env file for sensitive client config (do NOT commit .env)
    env_file:
      - config/secrets/.env
    volumes:
      # Mount local Firebase service account JSON into the container if present
      - ./config/secrets/firebase-sa.json:/app/config/secrets/firebase-sa.json:ro
      - ./shared/testing-ui:/app/testing-notification:ro
    environment:
      # Path the app expects for the service account JSON inside the container
      FIREBASE_SERVICE_ACCOUNT_PATH: /app/config/secrets/firebase-sa.json
    ports:
      - "50051:50051"

  push-notification:
    env_file:
      - config/secrets/.env
    volumes:
      - ./config/secrets/firebase-sa.json:/app/config/secrets/firebase-sa.json:ro
    environment:
      FIREBASE_SERVICE_ACCOUNT_PATH: /app/config/secrets/firebase-sa.json
      FCM_FALLBACK_V1: 'true'

  email-dispatcher:
    build:
      context: .
      dockerfile: ./services/email-service/Dockerfile
    container_name: email-dispatcher
    depends_on:
      hivemq:
        condition: service_healthy
      mongo:
        condition: service_healthy
    env_file:
      - config/secrets/.env
    environment:
      - MQTT_BROKER=hivemq
      - MQTT_PORT=1883
    restart: unless-stopped
    ports:
      - "4003:4003" # metrics endpoint for email-service

  sms-dispatcher:
    build:
      context: .
      dockerfile: ./services/sms-service/Dockerfile
    container_name: sms-dispatcher
    env_file:
      - config/secrets/.env
    environment:
      - MQTT_BROKER=hivemq
      - MQTT_PORT=1883
      - METRICS_PORT=4004
    depends_on:
      hivemq:
        condition: service_healthy
    restart: unless-stopped
    ports:
      - "4004:4004"

